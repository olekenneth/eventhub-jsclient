!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("isomorphic-ws")):"function"==typeof define&&define.amd?define(["isomorphic-ws"],t):e.Eventhub=t(e.WebSocket)}(this,function(e){e=e&&e.hasOwnProperty("default")?e.default:e;var t,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function r(){r.init.call(this)}var o=r;r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var c,u,a=10;function p(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?r.defaultMaxListeners:e._maxListeners}function l(e,t,n,i){var s,r,o;if(p(n),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),o=r[t]),void 0===o)o=r[t]=n,++e._eventsCount;else if("function"==typeof o?o=r[t]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),(s=h(e))>0&&o.length>s&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,console&&console.warn&&console.warn(c)}return e}function f(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(i);return s.listener=n,i.wrapFn=s,s}function v(e,t,n){var i=e._events;if(void 0===i)return[];var s=i[t];return void 0===s?[]:"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):_(s,s.length)}function d(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function _(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),r.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},r.prototype.getMaxListeners=function(){return h(this)},r.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,r=this._events;if(void 0!==r)s=s&&void 0===r.error;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var u=r[e];if(void 0===u)return!1;if("function"==typeof u)i(u,this,t);else{var a=u.length,p=_(u,a);for(n=0;n<a;++n)i(p[n],this,t)}return!0},r.prototype.on=r.prototype.addListener=function(e,t){return l(this,e,t,!1)},r.prototype.prependListener=function(e,t){return l(this,e,t,!0)},r.prototype.once=function(e,t){return p(t),this.on(e,f(this,e,t)),this},r.prototype.prependOnceListener=function(e,t){return p(t),this.prependListener(e,f(this,e,t)),this},r.prototype.off=r.prototype.removeListener=function(e,t){var n,i,s,r,o;if(p(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,r=n.length-1;r>=0;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,s=r;break}if(s<0)return this;0===s?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,s),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},r.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var s,r=Object.keys(n);for(i=0;i<r.length;++i)"removeListener"!==(s=r[i])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},r.prototype.listeners=function(e){return v(this,e,!0)},r.prototype.rawListeners=function(e){return v(this,e,!1)},r.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},r.prototype.listenerCount=d,r.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]},o.once=function(e,t){return new Promise(function(n,i){function s(){void 0!==r&&e.removeListener("error",r),n([].slice.call(arguments))}var r;"error"!==t&&(r=function(n){e.removeListener(t,s),i(n)},e.once("error",r)),e.once(t,s)})},function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_ALL="unsubscribeAll",e.LIST="list",e.HISTORY="history",e.PING="ping",e.DISCONNECT="disconnect"}(c||(c={})),function(e){e.CONNECT="connect",e.RECONNECT="reconnect",e.DISCONNECT="disconnect",e.OFFLINE="offline"}(u||(u={}));var b=function(){this.pingInterval=1e4,this.pingTimeout=3e3,this.maxFailedPings=3,this.reconnectInterval=1e4,this.disablePingCheck=!1};return function(t){function n(e,n,i){t.call(this),this._rpcResponseCounter=0,this._rpcCallbackList=[],this._subscriptionCallbackList=[],this._sentPingsList=[],this._wsUrl=e+"/?auth="+n,this._socket=void 0,this._isConnected=!1,this._opts=new b,Object.assign(this._opts,i)}return t&&(n.__proto__=t),(n.prototype=Object.create(t&&t.prototype)).constructor=n,n.prototype.connect=function(){var t=this;return new Promise(function(n,i){t._socket=new e(t._wsUrl),t._socket.onmessage=t._parseRPCResponse.bind(t),t._socket.onopen=function(){this.emit(u.CONNECT),this._isConnected=!0,this._opts.disablePingCheck||this._startPingMonitor(),n(!0)}.bind(t),t._socket.onerror=function(e){this.emit(u.OFFLINE,e),this._isConnected?(console.log("Eventhub WebSocket connection error:",e),this._isConnected=!1,this._reconnect()):i(e)}.bind(t),t._socket.onclose=function(e){this._isConnected&&(this.emit(u.OFFLINE,e),this._isConnected=!1,this._reconnect())}.bind(t)})},n.prototype._reconnect=function(){var t=this;if(!this._isConnected){this.emit(u.RECONNECT);var n=this._opts.reconnectInterval;this._socket.readyState!=e.CLOSED&&this._socket.readyState!=e.CLOSING&&this._socket.close(),this._opts.disablePingCheck||(clearInterval(this._pingTimer),clearInterval(this._pingTimeOutTimer),this._sentPingsList=[]),this.connect().then(function(e){var n=t._subscriptionCallbackList.slice();t._rpcResponseCounter=0,t._rpcCallbackList=[],t._subscriptionCallbackList=[];for(var i=0,s=n;i<s.length;i+=1){var r=s[i];t.subscribe(r.topic,r.callback,{sinceEventId:r.lastRecvMessageId})}}).catch(function(e){setTimeout(t._reconnect.bind(t),n)})}},n.prototype._startPingMonitor=function(){var e=this._opts.pingInterval,t=this._opts.maxFailedPings;this._pingTimer=setInterval(function(){var e=this;if(this._isConnected){var t={timestamp:Date.now(),rpcRequestId:this._rpcResponseCounter+1};this._sentPingsList.push(t),this._sendRPCRequest(c.PING,[]).then(function(n){for(var i=0;i<e._sentPingsList.length;i++)e._sentPingsList[i].rpcRequestId==t.rpcRequestId&&e._sentPingsList.splice(i,1)})}}.bind(this),e),this._pingTimeOutTimer=setInterval(function(){for(var e=Date.now(),n=0,i=0;i<this._sentPingsList.length;i++)e>this._sentPingsList[i].timestamp+this._opts.pingTimeout&&n++;n>=t&&(this._isConnected=!1,this._reconnect())}.bind(this),e)},n.prototype._sendRPCRequest=function(t,n){var i=this;this._rpcResponseCounter++;var s={id:this._rpcResponseCounter,jsonrpc:"2.0",method:t,params:n};return new Promise(function(t,n){if(i._socket.readyState==e.OPEN){i._rpcCallbackList.push([i._rpcResponseCounter,function(e,i){null!=e?n(e):t(i)}.bind(i)]);try{i._socket.send(JSON.stringify(s))}catch(e){n(e)}}else n(new Error("WebSocket is not connected."))})},n.prototype._parseRPCResponse=function(e){try{var t=JSON.parse(e.data);if(!t.hasOwnProperty("id")||"null"==t.id)return;if(t.hasOwnProperty("result")&&t.result.hasOwnProperty("message")&&t.result.hasOwnProperty("topic"))for(var n=0,i=this._subscriptionCallbackList;n<i.length;n+=1){var s=i[n];if(s.rpcRequestId==t.id)return s.lastRecvMessageId=t.result.id,void s.callback(t.result)}for(var r=void 0,o=0,c=this._rpcCallbackList;o<c.length;o+=1){var u=c[o];if(u[0]==t.id){r=u[1];break}}if(void 0===r)return;t.hasOwnProperty("error")?r(t.error,null):t.hasOwnProperty("result")&&r(null,t.result);for(var a=0;a<this._rpcCallbackList.length;a++)this._rpcCallbackList[a][0]==t.id&&this._rpcCallbackList.splice(a,1)}catch(e){return void console.log("Failed to parse websocket response:",e)}},n.prototype.isSubscribed=function(e){for(var t=0,n=this._subscriptionCallbackList;t<n.length;t+=1)if(n[t].topic==e)return!0;return!1},n.prototype.subscribe=function(e,t,n){var i={topic:e};return""==e?new Promise(function(e,t){t(new Error("Topic cannot be empty."))}):(void 0!==n&&(i=Object.assign(i,n)),this.isSubscribed(e)?new Promise(function(t,n){n(new Error("Already subscribed to "+e))}):(this._subscriptionCallbackList.push({topic:e,rpcRequestId:this._rpcResponseCounter+1,callback:t}),this._sendRPCRequest(c.SUBSCRIBE,i)))},n.prototype.unsubscribe=function(e){var t=[];if("string"==typeof e?t.push(e):t=e,t.length>0){for(var n=0,i=t;n<i.length;n+=1)for(var s=i[n],r=0;r<this._subscriptionCallbackList.length;r++)s==this._subscriptionCallbackList[r].topic&&this._subscriptionCallbackList.splice(r,1);this._sendRPCRequest(c.UNSUBSCRIBE,t)}},n.prototype.unsubscribeAll=function(){this._subscriptionCallbackList=[],this._sendRPCRequest(c.UNSUBSCRIBE_ALL,[])},n.prototype.publish=function(e,t,n){var i={topic:e,message:t};return void 0!==n&&(i=Object.assign(i,n)),this._sendRPCRequest(c.PUBLISH,i)},n.prototype.listSubscriptions=function(){return this._sendRPCRequest(c.LIST,[])},n.prototype.disconnect=function(){this._isConnected=!1;var e=this._sendRPCRequest(c.DISCONNECT,[]);return this.emit(u.DISCONNECT),e},n}(o)});
//# sourceMappingURL=eventhub.umd.js.map
